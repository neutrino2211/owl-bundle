{"id":"ZZQV","dependencies":[{"name":"/home/tbranyen/git/diffhtml/packages/diffhtml/package.json","includedInParent":true,"mtime":1534977442154},{"name":"/home/tbranyen/git/diffhtml/packages/diffhtml/.babelrc","includedInParent":true,"mtime":1534634600429},{"name":"./pool","loc":{"line":1,"column":17},"parent":"/home/tbranyen/git/diffhtml/packages/diffhtml/lib/util/memory.js","resolved":"/home/tbranyen/git/diffhtml/packages/diffhtml/lib/util/pool.js"},{"name":"./caches","loc":{"line":2,"column":55},"parent":"/home/tbranyen/git/diffhtml/packages/diffhtml/lib/util/memory.js","resolved":"/home/tbranyen/git/diffhtml/packages/diffhtml/lib/util/caches.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.protectVTree=d,exports.unprotectVTree=l,exports.cleanMemory=i;var e=require(\"./pool\"),r=o(e),t=require(\"./caches\");function o(e){return e&&e.__esModule?e:{default:e}}var c=t.MiddlewareCache.ReleaseHookCache,n=r.default.memory,a=r.default.protect,u=r.default.unprotect;function d(e){a(e);for(var r=0;r<e.childNodes.length;r++)d(e.childNodes[r]);return e}function l(e){u(e),c.size&&c.forEach(function(r){return r(e)});for(var r=0;r<e.childNodes.length;r++)l(e.childNodes[r]);return e}function i(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t.StateCache.forEach(function(r){return e=e||r.isRendering}),e||(n.allocated.forEach(function(e){return n.free.add(e)}),n.allocated.clear(),t.NodeCache.forEach(function(e,r){n.protected.has(r)||(t.NodeCache.delete(r),c.size&&c.forEach(function(e){return e(r)}))}))}","map":{"mappings":[{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":0}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":13}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":20}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":35}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":43}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":56}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":57}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":64}},{"source":"util/memory.js","name":"protectVTree","original":{"line":13,"column":16},"generated":{"line":1,"column":68}},{"source":"util/memory.js","name":"protectVTree","original":{"line":13,"column":16},"generated":{"line":1,"column":76}},{"source":"util/memory.js","name":"protectVTree","original":{"line":13,"column":16},"generated":{"line":1,"column":89}},{"source":"util/memory.js","name":"unprotectVTree","original":{"line":29,"column":16},"generated":{"line":1,"column":91}},{"source":"util/memory.js","name":"unprotectVTree","original":{"line":29,"column":16},"generated":{"line":1,"column":99}},{"source":"util/memory.js","name":"unprotectVTree","original":{"line":29,"column":16},"generated":{"line":1,"column":114}},{"source":"util/memory.js","name":"cleanMemory","original":{"line":47,"column":16},"generated":{"line":1,"column":116}},{"source":"util/memory.js","name":"cleanMemory","original":{"line":47,"column":16},"generated":{"line":1,"column":124}},{"source":"util/memory.js","name":"cleanMemory","original":{"line":47,"column":16},"generated":{"line":1,"column":136}},{"source":"util/memory.js","original":{"line":1,"column":0},"generated":{"line":1,"column":138}},{"source":"util/memory.js","original":{"line":1,"column":0},"generated":{"line":1,"column":142}},{"source":"util/memory.js","original":{"line":1,"column":0},"generated":{"line":1,"column":144}},{"source":"util/memory.js","original":{"line":1,"column":0},"generated":{"line":1,"column":152}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":162}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":164}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":166}},{"source":"util/memory.js","original":{"line":2,"column":0},"generated":{"line":1,"column":169}},{"source":"util/memory.js","original":{"line":2,"column":0},"generated":{"line":1,"column":171}},{"source":"util/memory.js","original":{"line":2,"column":0},"generated":{"line":1,"column":179}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":191}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":200}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":202}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":205}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":212}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":215}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":217}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":228}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":230}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":231}},{"source":"util/memory.js","original":{"line":66,"column":1},"generated":{"line":1,"column":239}},{"source":"util/memory.js","name":"ReleaseHookCache","original":{"line":4,"column":8},"generated":{"line":1,"column":242}},{"source":"util/memory.js","name":"ReleaseHookCache","original":{"line":4,"column":8},"generated":{"line":1,"column":246}},{"source":"util/memory.js","name":"MiddlewareCache","original":{"line":4,"column":29},"generated":{"line":1,"column":248}},{"source":"util/memory.js","name":"ReleaseHookCache","original":{"line":4,"column":8},"generated":{"line":1,"column":250}},{"source":"util/memory.js","name":"ReleaseHookCache","original":{"line":4,"column":8},"generated":{"line":1,"column":266}},{"source":"util/memory.js","name":"memory","original":{"line":5,"column":8},"generated":{"line":1,"column":283}},{"source":"util/memory.js","name":"Pool","original":{"line":5,"column":39},"generated":{"line":1,"column":285}},{"source":"util/memory.js","name":"memory","original":{"line":5,"column":8},"generated":{"line":1,"column":287}},{"source":"util/memory.js","name":"memory","original":{"line":5,"column":8},"generated":{"line":1,"column":295}},{"source":"util/memory.js","name":"protect","original":{"line":5,"column":16},"generated":{"line":1,"column":302}},{"source":"util/memory.js","name":"Pool","original":{"line":5,"column":39},"generated":{"line":1,"column":304}},{"source":"util/memory.js","name":"protect","original":{"line":5,"column":16},"generated":{"line":1,"column":306}},{"source":"util/memory.js","name":"protect","original":{"line":5,"column":16},"generated":{"line":1,"column":314}},{"source":"util/memory.js","name":"unprotect","original":{"line":5,"column":25},"generated":{"line":1,"column":322}},{"source":"util/memory.js","name":"Pool","original":{"line":5,"column":39},"generated":{"line":1,"column":324}},{"source":"util/memory.js","name":"unprotect","original":{"line":5,"column":25},"generated":{"line":1,"column":326}},{"source":"util/memory.js","name":"unprotect","original":{"line":5,"column":25},"generated":{"line":1,"column":334}},{"source":"util/memory.js","original":{"line":13,"column":7},"generated":{"line":1,"column":344}},{"source":"util/memory.js","name":"protectVTree","original":{"line":13,"column":16},"generated":{"line":1,"column":353}},{"source":"util/memory.js","name":"vTree","original":{"line":13,"column":29},"generated":{"line":1,"column":355}},{"source":"util/memory.js","name":"vTree","original":{"line":14,"column":10},"generated":{"line":1,"column":358}},{"source":"util/memory.js","name":"vTree","original":{"line":14,"column":10},"generated":{"line":1,"column":360}},{"source":"util/memory.js","original":{"line":16,"column":7},"generated":{"line":1,"column":363}},{"source":"util/memory.js","original":{"line":16,"column":7},"generated":{"line":1,"column":367}},{"source":"util/memory.js","name":"i","original":{"line":16,"column":11},"generated":{"line":1,"column":371}},{"source":"util/memory.js","original":{"line":16,"column":15},"generated":{"line":1,"column":373}},{"source":"util/memory.js","name":"i","original":{"line":16,"column":18},"generated":{"line":1,"column":375}},{"source":"util/memory.js","name":"vTree","original":{"line":16,"column":22},"generated":{"line":1,"column":377}},{"source":"util/memory.js","name":"childNodes","original":{"line":16,"column":28},"generated":{"line":1,"column":379}},{"source":"util/memory.js","name":"length","original":{"line":16,"column":39},"generated":{"line":1,"column":390}},{"source":"util/memory.js","name":"i","original":{"line":16,"column":47},"generated":{"line":1,"column":397}},{"source":"util/memory.js","name":"vTree","original":{"line":17,"column":17},"generated":{"line":1,"column":401}},{"source":"util/memory.js","name":"vTree","original":{"line":17,"column":17},"generated":{"line":1,"column":403}},{"source":"util/memory.js","name":"childNodes","original":{"line":17,"column":23},"generated":{"line":1,"column":405}},{"source":"util/memory.js","name":"i","original":{"line":17,"column":34},"generated":{"line":1,"column":416}},{"source":"util/memory.js","name":"vTree","original":{"line":20,"column":9},"generated":{"line":1,"column":420}},{"source":"util/memory.js","name":"vTree","original":{"line":20,"column":9},"generated":{"line":1,"column":427}},{"source":"util/memory.js","original":{"line":29,"column":7},"generated":{"line":1,"column":429}},{"source":"util/memory.js","name":"unprotectVTree","original":{"line":29,"column":16},"generated":{"line":1,"column":438}},{"source":"util/memory.js","name":"vTree","original":{"line":29,"column":31},"generated":{"line":1,"column":440}},{"source":"util/memory.js","name":"vTree","original":{"line":30,"column":12},"generated":{"line":1,"column":443}},{"source":"util/memory.js","name":"vTree","original":{"line":30,"column":12},"generated":{"line":1,"column":445}},{"source":"util/memory.js","name":"ReleaseHookCache","original":{"line":32,"column":6},"generated":{"line":1,"column":448}},{"source":"util/memory.js","name":"size","original":{"line":32,"column":23},"generated":{"line":1,"column":450}},{"source":"util/memory.js","name":"forEach","original":{"line":33,"column":21},"generated":{"line":1,"column":456}},{"source":"util/memory.js","name":"forEach","original":{"line":33,"column":21},"generated":{"line":1,"column":458}},{"source":"util/memory.js","original":{"line":33,"column":29},"generated":{"line":1,"column":466}},{"source":"util/memory.js","original":{"line":33,"column":29},"generated":{"line":1,"column":475}},{"source":"util/memory.js","name":"fn","original":{"line":33,"column":35},"generated":{"line":1,"column":478}},{"source":"util/memory.js","name":"fn","original":{"line":33,"column":35},"generated":{"line":1,"column":485}},{"source":"util/memory.js","name":"vTree","original":{"line":33,"column":38},"generated":{"line":1,"column":487}},{"source":"util/memory.js","original":{"line":36,"column":7},"generated":{"line":1,"column":492}},{"source":"util/memory.js","original":{"line":36,"column":7},"generated":{"line":1,"column":496}},{"source":"util/memory.js","name":"i","original":{"line":36,"column":11},"generated":{"line":1,"column":500}},{"source":"util/memory.js","original":{"line":36,"column":15},"generated":{"line":1,"column":502}},{"source":"util/memory.js","name":"i","original":{"line":36,"column":18},"generated":{"line":1,"column":504}},{"source":"util/memory.js","name":"vTree","original":{"line":36,"column":22},"generated":{"line":1,"column":506}},{"source":"util/memory.js","name":"childNodes","original":{"line":36,"column":28},"generated":{"line":1,"column":508}},{"source":"util/memory.js","name":"length","original":{"line":36,"column":39},"generated":{"line":1,"column":519}},{"source":"util/memory.js","name":"i","original":{"line":36,"column":47},"generated":{"line":1,"column":526}},{"source":"util/memory.js","name":"vTree","original":{"line":37,"column":19},"generated":{"line":1,"column":530}},{"source":"util/memory.js","name":"vTree","original":{"line":37,"column":19},"generated":{"line":1,"column":532}},{"source":"util/memory.js","name":"childNodes","original":{"line":37,"column":25},"generated":{"line":1,"column":534}},{"source":"util/memory.js","name":"i","original":{"line":37,"column":36},"generated":{"line":1,"column":545}},{"source":"util/memory.js","name":"vTree","original":{"line":40,"column":9},"generated":{"line":1,"column":549}},{"source":"util/memory.js","name":"vTree","original":{"line":40,"column":9},"generated":{"line":1,"column":556}},{"source":"util/memory.js","original":{"line":47,"column":7},"generated":{"line":1,"column":558}},{"source":"util/memory.js","name":"cleanMemory","original":{"line":47,"column":16},"generated":{"line":1,"column":567}},{"source":"util/memory.js","name":"isBusy","original":{"line":47,"column":28},"generated":{"line":1,"column":571}},{"source":"util/memory.js","name":"isBusy","original":{"line":47,"column":28},"generated":{"line":1,"column":575}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":577}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":587}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":594}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":602}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":606}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":616}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":620}},{"source":"util/memory.js","original":{"line":47,"column":37},"generated":{"line":1,"column":630}},{"source":"util/memory.js","name":"forEach","original":{"line":48,"column":13},"generated":{"line":1,"column":633}},{"source":"util/memory.js","name":"forEach","original":{"line":48,"column":13},"generated":{"line":1,"column":635}},{"source":"util/memory.js","name":"forEach","original":{"line":48,"column":13},"generated":{"line":1,"column":646}},{"source":"util/memory.js","original":{"line":48,"column":21},"generated":{"line":1,"column":654}},{"source":"util/memory.js","original":{"line":48,"column":21},"generated":{"line":1,"column":663}},{"source":"util/memory.js","name":"isBusy","original":{"line":48,"column":31},"generated":{"line":1,"column":666}},{"source":"util/memory.js","name":"isBusy","original":{"line":48,"column":31},"generated":{"line":1,"column":673}},{"source":"util/memory.js","name":"isBusy","original":{"line":48,"column":40},"generated":{"line":1,"column":675}},{"source":"util/memory.js","name":"state","original":{"line":48,"column":50},"generated":{"line":1,"column":678}},{"source":"util/memory.js","name":"isRendering","original":{"line":48,"column":56},"generated":{"line":1,"column":680}},{"source":"util/memory.js","name":"isBusy","original":{"line":52,"column":7},"generated":{"line":1,"column":694}},{"source":"util/memory.js","name":"allocated","original":{"line":53,"column":11},"generated":{"line":1,"column":698}},{"source":"util/memory.js","name":"allocated","original":{"line":53,"column":11},"generated":{"line":1,"column":700}},{"source":"util/memory.js","name":"forEach","original":{"line":53,"column":21},"generated":{"line":1,"column":710}},{"source":"util/memory.js","original":{"line":53,"column":29},"generated":{"line":1,"column":718}},{"source":"util/memory.js","original":{"line":53,"column":29},"generated":{"line":1,"column":727}},{"source":"util/memory.js","name":"memory","original":{"line":53,"column":38},"generated":{"line":1,"column":730}},{"source":"util/memory.js","name":"memory","original":{"line":53,"column":38},"generated":{"line":1,"column":737}},{"source":"util/memory.js","name":"free","original":{"line":53,"column":45},"generated":{"line":1,"column":739}},{"source":"util/memory.js","name":"add","original":{"line":53,"column":50},"generated":{"line":1,"column":744}},{"source":"util/memory.js","name":"vTree","original":{"line":53,"column":54},"generated":{"line":1,"column":748}},{"source":"util/memory.js","name":"allocated","original":{"line":54,"column":11},"generated":{"line":1,"column":753}},{"source":"util/memory.js","name":"allocated","original":{"line":54,"column":11},"generated":{"line":1,"column":755}},{"source":"util/memory.js","name":"clear","original":{"line":54,"column":21},"generated":{"line":1,"column":765}},{"source":"util/memory.js","name":"forEach","original":{"line":56,"column":14},"generated":{"line":1,"column":773}},{"source":"util/memory.js","name":"forEach","original":{"line":56,"column":14},"generated":{"line":1,"column":775}},{"source":"util/memory.js","name":"forEach","original":{"line":56,"column":14},"generated":{"line":1,"column":785}},{"source":"util/memory.js","original":{"line":56,"column":22},"generated":{"line":1,"column":793}},{"source":"util/memory.js","name":"node","original":{"line":56,"column":23},"generated":{"line":1,"column":802}},{"source":"util/memory.js","name":"vTree","original":{"line":56,"column":29},"generated":{"line":1,"column":804}},{"source":"util/memory.js","name":"memory","original":{"line":57,"column":11},"generated":{"line":1,"column":807}},{"source":"util/memory.js","name":"protected","original":{"line":57,"column":18},"generated":{"line":1,"column":809}},{"source":"util/memory.js","name":"has","original":{"line":57,"column":28},"generated":{"line":1,"column":819}},{"source":"util/memory.js","name":"vTree","original":{"line":57,"column":32},"generated":{"line":1,"column":823}},{"source":"util/memory.js","name":"delete","original":{"line":58,"column":18},"generated":{"line":1,"column":828}},{"source":"util/memory.js","name":"delete","original":{"line":58,"column":18},"generated":{"line":1,"column":830}},{"source":"util/memory.js","name":"delete","original":{"line":58,"column":18},"generated":{"line":1,"column":840}},{"source":"util/memory.js","name":"vTree","original":{"line":58,"column":25},"generated":{"line":1,"column":847}},{"source":"util/memory.js","name":"ReleaseHookCache","original":{"line":60,"column":12},"generated":{"line":1,"column":850}},{"source":"util/memory.js","name":"size","original":{"line":60,"column":29},"generated":{"line":1,"column":852}},{"source":"util/memory.js","name":"forEach","original":{"line":61,"column":27},"generated":{"line":1,"column":858}},{"source":"util/memory.js","name":"forEach","original":{"line":61,"column":27},"generated":{"line":1,"column":860}},{"source":"util/memory.js","original":{"line":61,"column":35},"generated":{"line":1,"column":868}},{"source":"util/memory.js","original":{"line":61,"column":35},"generated":{"line":1,"column":877}},{"source":"util/memory.js","name":"fn","original":{"line":61,"column":41},"generated":{"line":1,"column":880}},{"source":"util/memory.js","name":"fn","original":{"line":61,"column":41},"generated":{"line":1,"column":887}},{"source":"util/memory.js","name":"vTree","original":{"line":61,"column":44},"generated":{"line":1,"column":889}}],"sources":{"util/memory.js":"import Pool from './pool';\nimport { NodeCache, StateCache, MiddlewareCache } from './caches';\n\nconst { ReleaseHookCache } = MiddlewareCache;\nconst { memory, protect, unprotect } = Pool;\n\n/**\n * Ensures that an vTree is not recycled during a render cycle.\n *\n * @param vTree\n * @return vTree\n */\nexport function protectVTree(vTree) {\n  protect(vTree);\n\n  for (let i = 0; i < vTree.childNodes.length; i++) {\n    protectVTree(vTree.childNodes[i]);\n  }\n\n  return vTree;\n}\n\n/**\n * Allows an vTree to be recycled during a render cycle.\n *\n * @param vTree\n * @return\n */\nexport function unprotectVTree(vTree) {\n  unprotect(vTree);\n\n  if (ReleaseHookCache.size) {\n    ReleaseHookCache.forEach(fn => fn(vTree));\n  }\n\n  for (let i = 0; i < vTree.childNodes.length; i++) {\n    unprotectVTree(vTree.childNodes[i]);\n  }\n\n  return vTree;\n}\n\n/**\n * Moves all unprotected allocations back into available pool. This keeps\n * diffHTML in a consistent state after synchronizing.\n */\nexport function cleanMemory(isBusy = false) {\n  StateCache.forEach(state => (isBusy = isBusy || state.isRendering));\n\n  // Clean out unused elements, if we have any elements cached that no longer\n  // have a backing VTree, we can safely remove them from the cache.\n  if (!isBusy) {\n    memory.allocated.forEach(vTree => memory.free.add(vTree));\n    memory.allocated.clear();\n\n    NodeCache.forEach((node, vTree) => {\n      if (!memory.protected.has(vTree)) {\n        NodeCache.delete(vTree);\n\n        if (ReleaseHookCache.size) {\n          ReleaseHookCache.forEach(fn => fn(vTree));\n        }\n      }\n    });\n  }\n}\n"},"lineCount":null}},"hash":"aaa884a7f1443c0d47c40f320eddde8b","cacheData":{"env":{}}}